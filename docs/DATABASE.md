## Database

### Engine & Versions
- PostgreSQL 16+
- Npgsql provider 9.x for EF Core
- Entity Framework Core 9

### Connection
- Config key: `ConnectionStrings:Default`
- Local dev (User Secrets recommended):
  - `Host=localhost;Port=5432;Database=OECore;Username=postgres;Password=postgres`

### Conventions
- Naming: snake_case for tables and columns (via EFCore.NamingConventions)
- Table names: as defined in legacy system (preserved for compatibility)
- Primary key: `id` bigint/integer generated by identity
- Timestamps: `timestamp` or `timestamp with time zone` for UTC
- Soft delete: `dtDeleted` nullable timestamp (legacy naming preserved)
- Foreign keys: `<entity>Id` (camelCase preserved from legacy)

### EF Core Configuration
- Provider: `UseNpgsql(connectionString)`
- Naming conventions: `UseSnakeCaseNamingConvention()`
- Entity configurations via Fluent API in `OECore.Infrastructure/Configurations`
- `DbSet<TEntity>` properties in `AppDbContext`

### Migrations
- Location: `src/OECore.Infrastructure/Migrations`
- Create: `dotnet ef migrations add <Name> --startup-project ../OECore.Api`
- Apply: `dotnet ef database update --startup-project ../OECore.Api`
- Current Migration: `AddTicketingSystem` (includes all 54 tables)

## Database Schema

### Core Identity & Organization (Phase 1)
| Table | Description | Key Relationships |
|-------|-------------|------------------|
| `user` | User accounts with extended profile data | FK to `company` (employer), `tblLanguage`, `tbl_CONFIG_Themes` |
| `company` | Organizations/companies | M:N with `user`, `region` |
| `profile` | User roles/profiles | Used in `user_company` |
| `region` | Geographic regions | M:N with `company` |
| `user_company` | User-Company associations | FK to `user`, `company`, `profile` |
| `company_region` | Company-Region associations | FK to `company`, `region` |

### Configuration - Basic (15 tables)
| Table | Description | Multilingual |
|-------|-------------|--------------|
| `tbl_CONFIG_AbuseOptions` | Abuse reporting options | ✓ (IT/DE/FR) |
| `tbl_CONFIG_CleanJobsConfiguration` | System cleanup job settings | ✗ |
| `tbl_CONFIG_ConfirmationOfPersonalDetailsOptions` | Personal details confirmation options | ✓ (IT/DE/FR) |
| `tbl_CONFIG_ContactPersonOptions` | Contact person options | ✓ (IT/DE/FR) |
| `tbl_CONFIG_ControlTypes` | Control/inspection types | ✓ (IT/DE/FR) |
| `tbl_CONFIG_Countries` | Country definitions | ✓ (DE/FR/IT) |
| `tbl_CONFIG_Currencies` | Currency definitions | ✗ |
| `tbl_CONFIG_EmailTexts_Destinations` | Email destination types | ✗ |
| `tbl_CONFIG_Firstnames` | First name catalog | ✗ |
| `tbl_CONFIG_LastNames` | Last name catalog | ✗ |
| `tbl_CONFIG_Log` | System audit log | ✗ |
| `tbl_CONFIG_OthersCategories` | Other category definitions | ✓ (IT/FR/DE) |
| `tbl_CONFIG_RefundReasons` | Refund reason codes | ✓ (DE/FR/IT) |
| `tbl_CONFIG_TableMapping` | Legacy table mapping | ✗ |
| `tbl_CONFIG_ZipAddressCity` | Address/postal code data | ✗ |

### Configuration - Advanced (3 tables)
| Table | Description | Relationships |
|-------|-------------|---------------|
| `tbl_CONFIG_Behaviours` | Behavior codes | ✗ |
| `tbl_CONFIG_CommentsTemplates` | Comment templates | ✗ |
| `tbl_CONFIG_EmailTexts` | Email text content | FK to `tbl_CONFIG_EmailTexts_Destinations` |

### Localization (2 tables)
| Table | Description | Usage |
|-------|-------------|-------|
| `tblLanguage` | Language definitions | Referenced by `user.language` |
| `tbl_CONFIG_Themes` | UI theme definitions | Referenced by `user.theme`, `tbl_CONFIG_Dashboards` |

### TIMETABLE System (7 tables) - GTFS Compatible
| Table | Description | GTFS Standard |
|-------|-------------|---------------|
| `tbl_TIMETABLE_agency` | Transit agencies | ✓ |
| `tbl_TIMETABLE_calendar` | Service calendars | ✓ |
| `tbl_TIMETABLE_stops` | Transit stops/stations | ✓ |
| `tbl_TIMETABLE_routes` | Transit routes | ✓ (FK to agency) |
| `tbl_TIMETABLE_trips` | Individual trips | ✓ (FK to route, calendar) |
| `tbl_TIMETABLE_stop_times` | Stop time schedules | ✓ (FK to trip, stop) |
| `tbl_TIMETABLE_calendar_dates` | Calendar exceptions | ✓ (FK to calendar) |

### Statistics & Logging (7 tables)
| Table | Description | User Tracking |
|-------|-------------|---------------|
| `tbl_STATISTICS_Logins` | User login statistics | FK to `user` |
| `tbl_STATISTICS_Uploads` | File upload statistics | FK to `user` |
| `tbl_STATISTICS_devicesData` | Device data (composite key) | ✗ |
| `tbl_DEBUG_Queries` | Debug query log | ✗ |
| `tbl_DEBUG_RequestTimeCheck` | Request performance log | ✗ |
| `tbl_DEVICE_LOGS_DeviceLogs` | Device operation logs | ✗ |
| `tbl_DEVICE_LOGS_IncidentLogs` | Incident/violation logs | ✗ |

### Application Configuration (2 tables)
| Table | Description | Features |
|-------|-------------|----------|
| `tbl_CONFIG_Applications` | Application definitions | Self-referencing hierarchy, multilingual |
| `tbl_CONFIG_Parameters` | System parameters | Soft delete support |

### Configuration with Dependencies (8 tables)
| Table | Description | Dependencies |
|-------|-------------|--------------|
| `tbl_CONFIG_ReasonsCategories` | Reason categories | Multilingual (EN/DE/FR/IT) |
| `tbl_CONFIG_ReasonsSubcategories` | Reason subcategories | FK to `tbl_CONFIG_AbuseOptions` |
| `tbl_CONFIG_Stations` | Transport stations | Geographic data (lat/lng) |
| `tbl_CONFIG_Routes` | Transport routes | Color coding, agency info |
| `tbl_CONFIG_StationsRoutes` | Station-Route mapping | ✗ |
| `tbl_CONFIG_TrafficTypes` | Traffic type definitions | Audit timestamps |
| `tbl_CONFIG_Dashboards` | User dashboards | FK to `tbl_CONFIG_Themes`, M:N with users |
| `tbl_CONFIG_Widgets` | Dashboard widgets | FK to `tbl_CONFIG_Applications`, multilingual |

### TICKETING System (7 tables) - Complete Ticketing Management
| Table | Description | Key Features |
|-------|-------------|-------------|
| `tbl_TICKETING_Categories` | Product categories | Multilingual (DE/FR/IT), ranking system |
| `tbl_TICKETING_Classes` | Product classes (1st, 2nd, etc.) | Multilingual (EN/DE/FR/IT) |
| `tbl_TICKETING_Products` | Complete product definitions | Extensive multilingual support, QR codes, soft delete |
| `tbl_TICKETING_ProductPrices` | Product pricing (composite key) | Price/half-price, FQ codes, class-based pricing |
| `tbl_TICKETING_Tickets` | Main ticket records | UUID primary key, geolocation, payment tracking |
| `tbl_TICKETING_TicketsLines` | Ticket line items | Billing details, currency, receipt data |
| `tbl_TICKETING_TicketsImages` | Ticket images/receipts | Image storage, receipt identification |

### Key Features

#### Multilingual Support
- **4 Languages**: English (EN), German (DE), French (FR), Italian (IT)
- **Pattern**: `text_en`, `text_de`, `text_fr`, `text_it` or `nameEN`, `nameDE`, etc.
- **Coverage**: Most user-facing configuration tables and TICKETING system

#### Soft Delete Pattern
- **Field**: `dtDeleted` (nullable timestamp)
- **Usage**: Logical deletion without data loss
- **Tables**: Most configuration tables and TICKETING products support soft delete

#### Audit Trail
- **Creation**: `dtCreated`, `dtModified`
- **Import Tracking**: `dtLastSQLIteImport`, `dtSharepointImport`
- **User Actions**: Tracked in `tbl_CONFIG_Log`

#### Geographic Data
- **Coordinates**: `lat`/`lng` fields (real type)
- **Swiss DIDOK**: Station identification system
- **Postal Data**: ZIP codes, cities, countries
- **Ticket Geolocation**: Purchase location tracking in TICKETING system

#### Performance Considerations
- **Indexes**: Created for all foreign keys
- **Composite Keys**: Used where appropriate (`tbl_STATISTICS_devicesData`, `tbl_TICKETING_ProductPrices`)
- **String Keys**: Some tables use string primary keys (`tbl_TIMETABLE_*`)
- **UUID Keys**: TICKETING tickets use GUID for distributed systems

### Data Types Used
- **Identifiers**: `bigint` (users, companies) or `integer` (config tables)
- **UUID**: `uuid` for TICKETING tickets and distributed tracking
- **Text**: `text` (unlimited) or `character varying(n)` (limited)
- **Timestamps**: `timestamp` (local) or `timestamp with time zone` (UTC)
- **Coordinates**: `real` for lat/lng, `numeric` for precise values
- **Boolean**: `boolean`
- **Composite Keys**: Multiple columns for complex relationships

### Migration Status
- **Total Tables**: 54 (including core identity tables)
- **Legacy Tables Migrated**: 48
- **Migration Files**: 
  - `20250828153529_CompleteOECoreMigration` (47 tables)
  - `20250829065609_AddTicketingSystem` (7 TICKETING tables)
- **Status**: ✅ Complete

### Performance & Operations
- **Index Strategy**: FK columns and frequent filters indexed
- **Naming Convention**: snake_case via EFCore.NamingConventions
- **Connection Pooling**: Handled by Npgsql
- **Health Checks**: Ready for implementation

### Development Notes
- **Legacy Compatibility**: Table and column names preserved from EF6 system
- **Type Mapping**: `datetime2` → `timestamp` for PostgreSQL compatibility
- **Relationship Patterns**: `OnDelete(DeleteBehavior.Restrict)` for data integrity
- **Configuration**: Fluent API used for all entity configurations
- **TICKETING System**: Complete multilingual support with advanced features (QR codes, geolocation, image storage)


